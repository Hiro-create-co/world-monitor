<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸–ç•Œç›£è¦–å±€ â€” WORLD MONITOR</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #060e18;
    --bg-secondary: #080f1a;
    --bg-panel: #0a1628;
    --bg-header: #0d1b2a;
    --border: #1a3a4a;
    --border-dim: #0a1e2e;
    --cyan: #0ff;
    --cyan-dim: #0ff80;
    --green: #76ff03;
    --yellow: #ffea00;
    --orange: #ff9100;
    --red: #ff1744;
    --blue: #40c4ff;
    --text: #c0dce8;
    --text-dim: #4a7a8a;
    --text-dimmer: #3a5a6a;
    --mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    --sans: 'Noto Sans JP', 'Hiragino Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    background: var(--bg-primary);
    color: var(--text);
    font-family: var(--sans);
    overflow: hidden;
    width: 100vw;
    height: 100vh;
  }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: var(--bg-panel); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Layout */
  .app {
    display: grid;
    grid-template-rows: 48px 1fr 24px;
    height: 100vh;
    width: 100vw;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    background: linear-gradient(180deg, var(--bg-header), var(--bg-panel));
    border-bottom: 1px solid var(--border);
    z-index: 1000;
  }

  .header-left { display: flex; align-items: center; gap: 16px; }

  .logo {
    display: flex; align-items: center; gap: 8px;
  }
  .logo-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--cyan);
    box-shadow: 0 0 8px var(--cyan), 0 0 16px rgba(0,255,255,0.2);
    animation: pulse 2s ease-in-out infinite;
  }
  .logo-text {
    font-family: var(--mono); font-size: 18px; font-weight: 700;
    color: var(--cyan); letter-spacing: 6px;
  }
  .logo-ver {
    font-family: var(--mono); font-size: 10px; color: var(--text-dim);
    letter-spacing: 2px;
  }

  .threat-badge {
    padding: 2px 10px; border-radius: 3px;
    display: flex; align-items: center; gap: 6px;
    font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
  }
  .threat-badge.normal {
    background: rgba(118,255,3,0.1); border: 1px solid var(--green); color: var(--green);
  }
  .threat-badge.elevated {
    background: rgba(255,145,0,0.1); border: 1px solid var(--orange); color: var(--orange);
  }
  .threat-dot {
    width: 6px; height: 6px; border-radius: 50%;
  }

  .header-right { display: flex; align-items: center; gap: 20px; }

  .clock {
    font-family: var(--mono); font-size: 16px; color: var(--cyan);
    letter-spacing: 2px; text-align: right;
  }
  .clock-sub {
    font-family: var(--mono); font-size: 9px; color: var(--text-dim);
    letter-spacing: 1px;
  }

  .badge {
    padding: 3px 8px; border-radius: 3px;
    font-family: var(--mono); font-size: 10px;
  }
  .badge-eq { background: rgba(255,23,68,0.15); border: 1px solid rgba(255,23,68,0.5); color: var(--red); }
  .badge-live { background: rgba(0,255,255,0.08); border: 1px solid rgba(0,255,255,0.25); color: var(--cyan); }

  /* Main content */
  .main {
    display: grid;
    grid-template-columns: 1fr 1.3fr 1fr;
    gap: 1px;
    background: var(--border);
    overflow: hidden;
  }

  /* Panels */
  .panel {
    background: var(--bg-secondary);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, #0d1f30, var(--bg-panel));
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .panel-header-left { display: flex; align-items: center; gap: 8px; }
  .panel-title {
    font-family: var(--mono); font-size: 12px; font-weight: 600;
    color: var(--cyan); letter-spacing: 2px;
  }
  .panel-subtitle {
    font-family: var(--mono); font-size: 9px; color: var(--text-dim);
  }
  .panel-badge {
    font-family: var(--mono); font-size: 10px; color: var(--cyan);
    padding: 1px 8px; background: rgba(0,255,255,0.06); border-radius: 10px;
  }
  .live-indicator {
    font-family: var(--mono); font-size: 9px; color: var(--red);
    display: flex; align-items: center; gap: 4px;
  }
  .live-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--red); animation: blink 1.5s infinite;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* YouTube embed */
  .youtube-container {
    position: relative;
    width: 100%;
    flex-shrink: 0;
  }
  .youtube-container iframe {
    width: 100%;
    aspect-ratio: 16/9;
    border: none;
  }
  .youtube-label {
    position: absolute; top: 6px; left: 6px; z-index: 10;
    padding: 2px 8px; background: rgba(255,23,68,0.85);
    border-radius: 2px; font-family: var(--mono); font-size: 9px;
    color: #fff; letter-spacing: 1px; font-weight: 600;
  }

  /* Stats bar */
  .stats-bar {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1px; background: var(--border); flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  .stat-item {
    padding: 8px 10px; background: var(--bg-panel); text-align: center;
  }
  .stat-value {
    font-family: var(--mono); font-size: 20px; font-weight: 700;
  }
  .stat-label {
    font-family: var(--mono); font-size: 8px; color: var(--text-dim);
    letter-spacing: 1px; margin-top: 2px;
  }

  /* Section divider */
  .section-label {
    padding: 5px 14px; background: #06101a;
    border-bottom: 1px solid var(--border-dim);
    font-family: var(--mono); font-size: 10px;
    color: var(--text-dim); letter-spacing: 1px; flex-shrink: 0;
  }
  .section-label.japan {
    background: rgba(0,255,255,0.03);
    border-bottom: 1px solid rgba(0,255,255,0.12);
    color: var(--cyan);
  }

  /* Earthquake item */
  .eq-item {
    padding: 8px 14px;
    border-bottom: 1px solid var(--border-dim);
    transition: background 0.2s;
    cursor: default;
  }
  .eq-item:hover { background: #0a2040; }
  .eq-item:nth-child(even) { background: #06101a; }
  .eq-item:nth-child(even):hover { background: #0a2040; }
  .eq-item.japan {
    background: rgba(0,255,255,0.03);
    border-left: 3px solid var(--cyan);
  }
  .eq-top { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
  .eq-mag {
    display: inline-flex; align-items: center; justify-content: center;
    min-width: 42px; padding: 2px 6px; font-size: 13px; font-weight: 700;
    font-family: var(--mono); border-radius: 3px;
  }
  .eq-mag-label {
    font-size: 9px; font-family: var(--mono); padding: 1px 5px; border-radius: 2px;
  }
  .eq-tsunami {
    font-size: 9px; font-family: var(--mono); color: var(--red);
    padding: 1px 5px; background: rgba(255,23,68,0.12);
    border: 1px solid rgba(255,23,68,0.35); border-radius: 2px;
    font-weight: 700; animation: blink 1s infinite;
  }
  .eq-japan-badge {
    font-size: 9px; font-family: var(--mono); color: var(--cyan);
    padding: 1px 5px; background: rgba(0,255,255,0.06); border-radius: 2px;
  }
  .eq-time {
    margin-left: auto; font-size: 10px; font-family: var(--mono); color: var(--text-dimmer);
  }
  .eq-place { font-size: 12px; color: #a0c0d0; line-height: 1.4; }
  .eq-depth { font-size: 10px; color: var(--text-dimmer); font-family: var(--mono); margin-top: 2px; }

  /* News tabs */
  .tabs {
    display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .tab {
    flex: 1; padding: 10px; border: none; cursor: pointer;
    background: var(--bg-secondary);
    border-bottom: 2px solid transparent;
    color: var(--text-dim); font-family: var(--mono);
    font-size: 11px; letter-spacing: 1px;
    transition: all 0.3s; display: flex;
    align-items: center; justify-content: center; gap: 6px;
  }
  .tab.active {
    background: #0d1f30; border-bottom-color: var(--cyan); color: var(--cyan);
  }
  .tab:hover { background: #0d1f30; }

  /* News item */
  .news-item {
    padding: 10px 14px; border-bottom: 1px solid var(--border-dim);
    transition: background 0.2s; cursor: default;
  }
  .news-item:hover { background: #0a2040; }
  .news-item:nth-child(even) { background: #06101a; }
  .news-item:nth-child(even):hover { background: #0a2040; }
  .news-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .news-level {
    padding: 1px 6px; font-size: 9px; font-family: var(--mono);
    border-radius: 2px; letter-spacing: 1px; font-weight: 600;
  }
  .news-category {
    padding: 1px 6px; font-size: 9px; font-family: var(--mono);
    background: rgba(0,255,255,0.04); color: var(--text-dim);
    border: 1px solid var(--border); border-radius: 2px;
  }
  .news-time {
    margin-left: auto; font-size: 10px; font-family: var(--mono); color: var(--text-dimmer);
  }
  .news-title { font-size: 13px; color: var(--text); line-height: 1.5; display: block; }
  a.news-title:hover { color: var(--cyan); }
  .news-source { font-size: 10px; color: var(--text-dimmer); font-family: var(--mono); margin-top: 3px; }

  /* Category tags */
  .tag-bar {
    border-top: 1px solid var(--border); padding: 10px 14px;
    display: flex; flex-wrap: wrap; gap: 6px; flex-shrink: 0;
  }
  .tag {
    padding: 2px 8px; font-size: 9px; font-family: var(--mono);
    background: rgba(0,255,255,0.04); color: #6a9aaa;
    border: 1px solid var(--border); border-radius: 10px;
  }

  /* Map panel */
  .map-panel {
    display: flex; flex-direction: column; overflow: hidden;
    background: var(--bg-primary);
  }

  #map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
  }

  /* Dark mode map tiles */
  .dark-tiles {
    filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
  }

  .leaflet-control-attribution { display: none !important; }
  .leaflet-control-zoom {
    border: 1px solid var(--border) !important;
  }
  .leaflet-control-zoom a {
    background: var(--bg-panel) !important;
    color: var(--cyan) !important;
    border-color: var(--border) !important;
  }
  .leaflet-control-zoom a:hover { background: #0d1f30 !important; }

  /* Map bottom panel */
  .map-bottom {
    display: grid; grid-template-columns: 200px 1fr;
    border-top: 1px solid var(--border);
    min-height: 140px; flex-shrink: 0;
  }

  .gauge-container {
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 10px;
  }
  .gauge-label {
    font-family: var(--mono); font-size: 9px; color: var(--text-dim);
    letter-spacing: 2px; margin-top: 4px;
  }

  .summary {
    padding: 12px 16px; overflow-y: auto;
  }
  .summary-title {
    font-family: var(--mono); font-size: 10px; color: var(--cyan);
    letter-spacing: 1px; margin-bottom: 8px;
  }
  .summary-text { font-size: 12px; color: #8ab0c0; line-height: 1.8; }
  .summary-hl { font-weight: 600; }
  .summary-source {
    margin-top: 8px; font-family: var(--mono); font-size: 9px; color: var(--text-dimmer);
  }

  .map-legend {
    position: absolute; bottom: 10px; left: 10px; z-index: 1000;
    display: flex; gap: 10px; background: rgba(6,14,24,0.9);
    padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border);
  }
  .legend-item { display: flex; align-items: center; gap: 4px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
  .legend-label { font-family: var(--mono); font-size: 9px; color: #6a8a9a; }

  /* Layer control panel */
  .layer-toggle-btn {
    position: absolute; top: 80px; left: 10px; z-index: 1001;
    width: 30px; height: 30px; background: var(--bg-panel);
    border: 1px solid var(--border); border-radius: 4px;
    color: var(--cyan); font-size: 14px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .layer-toggle-btn:hover { background: #0d1f30; }
  .layer-panel {
    position: absolute; top: 80px; left: 10px; z-index: 1001;
    background: rgba(10, 22, 40, 0.95); border: 1px solid var(--border);
    border-radius: 4px; min-width: 230px;
    font-family: var(--mono); backdrop-filter: blur(8px);
  }
  .layer-panel.hidden { display: none; }
  .layer-panel-header {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    font-size: 11px; color: var(--cyan); letter-spacing: 2px;
  }
  .layer-row {
    padding: 6px 12px; display: flex; align-items: center; gap: 8px;
    border-bottom: 1px solid var(--border-dim); cursor: pointer;
    transition: background 0.2s; margin: 0;
  }
  .layer-row:last-child { border-bottom: none; }
  .layer-row:hover { background: rgba(0,255,255,0.04); }
  .layer-row input[type="checkbox"] { accent-color: var(--cyan); cursor: pointer; }
  .layer-icon { font-size: 14px; width: 20px; text-align: center; }
  .layer-name { font-size: 10px; color: var(--text); flex: 1; }
  .layer-count {
    font-size: 9px; color: var(--text-dim);
    padding: 1px 6px; background: rgba(0,255,255,0.06);
    border-radius: 8px; min-width: 20px; text-align: center;
  }

  /* Footer */
  .footer {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: var(--bg-primary); border-top: 1px solid var(--border);
    font-family: var(--mono); font-size: 9px; color: var(--text-dimmer);
  }
  .footer-left { display: flex; gap: 20px; }
  .status-online { color: var(--green); }
  .status-demo { color: var(--yellow); }
  .status-error { color: var(--red); }

  /* Animations */
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes scanline {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100vh); }
  }

  .scanline {
    position: fixed; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, rgba(0,255,255,0.12), transparent);
    animation: scanline 8s linear infinite;
    pointer-events: none; z-index: 9999;
  }

  /* Earthquake popup */
  .leaflet-popup-content-wrapper {
    background: var(--bg-panel) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
    border-radius: 4px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
  }
  .leaflet-popup-tip { background: var(--bg-panel) !important; }
  .leaflet-popup-content { font-family: var(--sans); font-size: 12px; margin: 10px !important; }
  .popup-mag { font-family: var(--mono); font-weight: 700; font-size: 16px; }
  .popup-place { margin-top: 4px; color: #a0c0d0; }
  .popup-depth { font-family: var(--mono); font-size: 10px; color: var(--text-dim); margin-top: 2px; }
</style>
</head>
<body>

<div class="scanline"></div>

<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-dot"></div>
        <span class="logo-text">ä¸–ç•Œç›£è¦–å±€</span>
      </div>
      <span class="logo-ver">WORLD MONITOR v2.0</span>
      <div class="threat-badge normal" id="threatBadge">
        <div class="threat-dot" id="threatDot" style="background:var(--green)"></div>
        <span id="threatText">è­¦æˆ’ãƒ¬ãƒ™ãƒ«: é€šå¸¸</span>
      </div>
    </div>
    <div class="header-right">
      <div>
        <div class="clock" id="clock">--:--:-- JST</div>
        <div class="clock-sub">JST â€” TOKYO, JAPAN</div>
      </div>
      <div style="display:flex;gap:6px">
        <span class="badge badge-eq" id="eqCountBadge">åœ°éœ‡ --</span>
        <span class="badge badge-live">â— LIVE</span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Earthquake + YouTube -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-header-left">
          <span>ğŸ”´</span>
          <span class="panel-title">åœ°éœ‡ç›£è¦–</span>
          <span class="panel-subtitle">SEISMIC</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="panel-badge" id="eqTotal">--</span>
          <span class="live-indicator"><span class="live-dot"></span>LIVE</span>
        </div>
      </div>

      <!-- YouTube Live -->
      <div class="youtube-container">
        <span class="youtube-label">â— LIVE é…ä¿¡</span>
        <iframe src="https://www.youtube.com/embed/c7_kqMFDE8c?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&showinfo=0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>

      <!-- Stats -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-value" id="statTotal" style="color:var(--cyan)">--</div>
          <div class="stat-label">å…¨åœ°éœ‡ (24H)</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statJapan" style="color:var(--green)">--</div>
          <div class="stat-label">æ—¥æœ¬å‘¨è¾º</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statMax" style="color:var(--yellow)">--</div>
          <div class="stat-label">æœ€å¤§M</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statAvg" style="color:var(--text-dim)">--</div>
          <div class="stat-label">å¹³å‡M</div>
        </div>
      </div>

      <!-- Japan quakes section -->
      <div class="section-label japan" id="japanLabel" style="display:none">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å‘¨è¾ºã®åœ°éœ‡ (<span id="japanCount">0</span>)</div>
      <div id="japanQuakes"></div>

      <div class="section-label">å…¨ä¸–ç•Œã®åœ°éœ‡</div>
      <div class="panel-body" id="allQuakes">
        <div style="padding:40px;text-align:center;color:var(--text-dim);font-family:var(--mono);animation:pulse 1.5s infinite">
          ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...
        </div>
      </div>
    </div>

    <!-- CENTER: Map -->
    <div class="map-panel">
      <div class="panel-header">
        <div class="panel-header-left">
          <span>ğŸŒ</span>
          <span class="panel-title">å…¨åœ°çƒçŠ¶æ³å›³</span>
          <span class="panel-subtitle">GLOBAL SITUATION</span>
        </div>
        <span class="live-indicator"><span class="live-dot"></span>LIVE</span>
      </div>
      <div style="flex:1;position:relative;min-height:0">
        <div id="map"></div>
        <!-- Layer control panel -->
        <div class="layer-panel" id="layerPanel">
          <div class="layer-panel-header">
            <span>LAYERS</span>
            <span style="cursor:pointer;font-size:14px" onclick="toggleLayerPanel()">Ã—</span>
          </div>
          <label class="layer-row">
            <input type="checkbox" checked onchange="toggleLayer('earthquakes', this.checked)">
            <span class="layer-icon">ğŸ”´</span>
            <span class="layer-name">åœ°éœ‡ SEISMIC</span>
            <span class="layer-count" id="layerCount-earthquakes">--</span>
          </label>
          <label class="layer-row">
            <input type="checkbox" checked onchange="toggleLayer('volcanoes', this.checked)">
            <span class="layer-icon">ğŸŒ‹</span>
            <span class="layer-name">ç«å±± VOLCANOES</span>
            <span class="layer-count" id="layerCount-volcanoes">--</span>
          </label>
          <label class="layer-row">
            <input type="checkbox" onchange="toggleLayer('wildfires', this.checked)">
            <span class="layer-icon">ğŸ”¥</span>
            <span class="layer-name">ç«ç½ WILDFIRES</span>
            <span class="layer-count" id="layerCount-wildfires">--</span>
          </label>
          <label class="layer-row">
            <input type="checkbox" checked onchange="toggleLayer('conflicts', this.checked)">
            <span class="layer-icon">âš¡</span>
            <span class="layer-name">ç´›äº‰ CONFLICTS</span>
            <span class="layer-count" id="layerCount-conflicts">--</span>
          </label>
          <label class="layer-row">
            <input type="checkbox" onchange="toggleLayer('nuclear', this.checked)">
            <span class="layer-icon">â˜¢</span>
            <span class="layer-name">åŸç™º NUCLEAR</span>
            <span class="layer-count" id="layerCount-nuclear">--</span>
          </label>
          <label class="layer-row">
            <input type="checkbox" onchange="toggleLayer('storms', this.checked)">
            <span class="layer-icon">ğŸŒ€</span>
            <span class="layer-name">æš´é¢¨ STORMS</span>
            <span class="layer-count" id="layerCount-storms">--</span>
          </label>
        </div>
        <button class="layer-toggle-btn hidden" id="layerToggleBtn" onclick="toggleLayerPanel()" title="ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º">â˜°</button>
        <div class="map-legend">
          <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div><span class="legend-label">M7+</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div><span class="legend-label">M5+</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--yellow)"></div><span class="legend-label">M3+</span></div>
          <div class="legend-item"><span class="legend-label" style="font-size:12px">ğŸŒ‹</span><span class="legend-label">ç«å±±</span></div>
          <div class="legend-item"><span class="legend-label" style="font-size:12px">ğŸ”¥</span><span class="legend-label">ç«ç½</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#ff1744"></div><span class="legend-label">ç´›äº‰</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#ffea00"></div><span class="legend-label">åŸç™º</span></div>
          <div class="legend-item"><span class="legend-label" style="font-size:12px">ğŸŒ€</span><span class="legend-label">æš´é¢¨</span></div>
        </div>
        <div style="position:absolute;top:10px;right:10px;z-index:1000;font-family:var(--mono);font-size:9px;color:var(--text-dimmer);background:rgba(6,14,24,0.9);padding:6px 10px;border-radius:3px;border:1px solid var(--border)">
          <span id="lastUpdate">æ›´æ–°: ---</span><br>æ¬¡å›æ›´æ–°: 2åˆ†æ¯
        </div>
      </div>

      <!-- Bottom: Gauge + Summary -->
      <div class="map-bottom">
        <div class="gauge-container">
          <svg viewBox="0 0 120 80" width="140" height="95">
            <defs>
              <linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%">
                <stop offset="0%" stop-color="var(--green)" />
                <stop offset="35%" stop-color="var(--yellow)" />
                <stop offset="65%" stop-color="var(--orange)" />
                <stop offset="100%" stop-color="var(--red)" />
              </linearGradient>
            </defs>
            <path d="M 15 65 A 45 45 0 0 1 105 65" fill="none" stroke="#1a2a3a" stroke-width="8" stroke-linecap="round" />
            <path id="gaugeArc" d="M 15 65 A 45 45 0 0 1 105 65" fill="none" stroke="url(#gaugeGrad)" stroke-width="8" stroke-linecap="round" stroke-dasharray="0 142" style="transition:stroke-dasharray 1s ease" />
            <text id="gaugeValue" x="60" y="52" text-anchor="middle" fill="var(--green)" font-size="22" font-weight="700" font-family="var(--mono)">--</text>
            <text id="gaugeLabel" x="60" y="72" text-anchor="middle" fill="var(--green)" font-size="10" font-family="var(--mono)">---</text>
          </svg>
          <div class="gauge-label">ç·åˆãƒªã‚¹ã‚¯æŒ‡æ•°</div>
        </div>
        <div class="summary">
          <div class="summary-title">ğŸ“Š çŠ¶æ³ã‚µãƒãƒªãƒ¼</div>
          <div class="summary-text" id="summaryText">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
          <div class="summary-source">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: USGS Earthquake Hazards Program (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: News -->
    <div class="panel">
      <div class="tabs">
        <button class="tab active" id="tabWorld" onclick="switchTab('world')">ğŸŒ ä¸–ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹</button>
        <button class="tab" id="tabTech" onclick="switchTab('tech')">ğŸ¤– AIãƒ»ãƒ†ãƒƒã‚¯</button>
      </div>
      <div class="section-label" id="newsSubLabel">åœ°æ”¿å­¦ãƒ»çµŒæ¸ˆãƒ»ç´›äº‰ â€” <span id="newsCount">--</span> ä»¶</div>
      <div class="panel-body" id="newsBody"></div>
      <div class="tag-bar" id="tagBar"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-left">
      <span>USGS: <span class="status-online" id="apiStatus">ONLINE</span></span>
      <span>NASA EONET: <span class="status-online">ONLINE</span></span>
      <span>GDELT: <span class="status-online">ONLINE</span></span>
      <span>YouTube: <span class="status-online">LIVE</span></span>
      <span>ãƒ‹ãƒ¥ãƒ¼ã‚¹: <span class="status-online" id="newsFeedStatus">LIVE</span></span>
    </div>
    <div>ä¸–ç•Œç›£è¦–å±€ â€” Powered by USGS & NASA EONET & GDELT & YouTube Live</div>
  </footer>
</div>

<script>
// â”€â”€â”€ DATA â”€â”€â”€
let WORLD_NEWS = [];
let TECH_NEWS = [];

// GDELT seendate parser: "20260214T233000Z" -> Date
function parseGdeltDate(s) {
  if (!s || s.length < 15) return new Date();
  return new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T${s.slice(9,11)}:${s.slice(11,13)}:${s.slice(13,15)}Z`);
}

// Derive news category from title keywords
function deriveCategory(title, domain) {
  const t = (title + ' ' + domain).toLowerCase();
  const rules = [
    [/æˆ¦äº‰|ç´›äº‰|è»äº‹|æ”»æ’ƒ|çˆ†ç™º|ãƒ†ãƒ­|war|attack|military|bomb|conflict|strike/i, 'ç´›äº‰'],
    [/å®‰ä¿|é˜²è¡›|nato|missile|ãƒŸã‚µã‚¤ãƒ«|æ ¸|nuclear|weapon|icbm/i, 'å®‰å…¨ä¿éšœ'],
    [/çµŒæ¸ˆ|gdp|å¸‚å ´|æ ª|è²¿æ˜“|trade|economy|inflation|recession/i, 'çµŒæ¸ˆ'],
    [/æ”¿æ²»|æ”¿æ¨©|é¸æŒ™|å¤–äº¤|å¤§çµ±é ˜|é¦–ç›¸|sanction|election|diplomacy/i, 'åœ°æ”¿å­¦'],
    [/ai|äººå·¥çŸ¥èƒ½|æ©Ÿæ¢°å­¦ç¿’|llm|chatgpt|claude|gemini|openai|anthropic|deepmind/i, 'AI'],
    [/åŠå°ä½“|chip|semiconductor|nvidia|tsmc|intel|amd/i, 'åŠå°ä½“'],
    [/å®‡å®™|space|nasa|rocket|è¡›æ˜Ÿ|spacex|starship/i, 'å®‡å®™'],
    [/é‡å­|quantum/i, 'é‡å­'],
    [/ç’°å¢ƒ|æ°—å€™|climate|carbon|emission/i, 'ç’°å¢ƒ'],
    [/ã‚¨ãƒãƒ«ã‚®ãƒ¼|åŸæ²¹|oil|gas|energy|opec/i, 'ã‚¨ãƒãƒ«ã‚®ãƒ¼'],
    [/è¦åˆ¶|æ³•å¾‹|æ³•æ¡ˆ|regulation|law|ban|compliance/i, 'è¦åˆ¶'],
  ];
  for (const [re, cat] of rules) {
    if (re.test(t)) return cat;
  }
  return 'å›½éš›';
}

// Derive urgency level from title keywords
function deriveLevel(title) {
  const t = title.toLowerCase();
  if (/é€Ÿå ±|breaking|urgent|ç·Šæ€¥|attack|explosion|çˆ†ç™º|æˆ¦äº‰|war|æ­»äº¡|killed/i.test(t)) return 'CRIT';
  if (/åˆ¶è£|sanction|è»äº‹|military|å±æ©Ÿ|crisis|æ‡¸å¿µ|threat|è­¦å‘Š|warn/i.test(t)) return 'HIGH';
  if (/ç™ºè¡¨|announce|report|è¨ˆç”»|plan|update/i.test(t)) return 'MED';
  return 'MED';
}

// News domain lists
// Keep domain lists short to avoid GDELT "query too long" error (max ~7 domains)
const WORLD_DOMAINS = 'domain:nhk.or.jp OR domain:jiji.com OR domain:yomiuri.co.jp OR domain:nikkei.com OR domain:sankei.com OR domain:afpbb.com OR domain:kyodo.co.jp';
const TECH_DOMAINS = 'domain:itmedia.co.jp OR domain:gigazine.net OR domain:wired.jp OR domain:gizmodo.jp OR domain:ascii.jp';

// Fetch world news from GDELT (filtered by major news media domains)
async function fetchWorldNews() {
  try {
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=sourcelang:japanese (${WORLD_DOMAINS})&mode=ArtList&maxrecords=30&format=json&sort=DateDesc&timespan=24h`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.articles || !data.articles.length) return;
    WORLD_NEWS = data.articles
      .filter(a => a.title && a.title.length > 10)
      .map(a => ({
        title: a.title,
        source: a.domain.replace('www.', ''),
        url: a.url,
        age: Math.max(0.1, (Date.now() - parseGdeltDate(a.seendate).getTime()) / 3600000),
        level: deriveLevel(a.title),
        cat: deriveCategory(a.title, a.domain),
      }));
    if (currentTab === 'world') renderNews(WORLD_NEWS);
    document.getElementById('newsFeedStatus').textContent = 'LIVE';
    document.getElementById('newsFeedStatus').className = 'status-online';
  } catch(e) {
    console.error('World news fetch error:', e);
    document.getElementById('newsFeedStatus').textContent = 'ERROR';
    document.getElementById('newsFeedStatus').className = 'status-error';
  }
}

// Fetch tech news from GDELT (filtered by tech media domains)
async function fetchTechNews() {
  try {
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=sourcelang:japanese (${TECH_DOMAINS})&mode=ArtList&maxrecords=30&format=json&sort=DateDesc&timespan=48h`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.articles || !data.articles.length) return;
    TECH_NEWS = data.articles
      .filter(a => a.title && a.title.length > 10)
      .map(a => ({
        title: a.title,
        source: a.domain.replace('www.', ''),
        url: a.url,
        age: Math.max(0.1, (Date.now() - parseGdeltDate(a.seendate).getTime()) / 3600000),
        level: deriveLevel(a.title),
        cat: deriveCategory(a.title, a.domain),
      }));
    if (currentTab === 'tech') renderNews(TECH_NEWS);
  } catch(e) {
    console.error('Tech news fetch error:', e);
  }
}

let currentTab = 'world';
let map, eqLayer;
let earthquakeData = [];
const layers = {
  earthquakes: { group: null, visible: true },
  volcanoes:   { group: null, visible: true },
  wildfires:   { group: null, visible: false },
  conflicts:   { group: null, visible: true },
  nuclear:     { group: null, visible: false },
  storms:      { group: null, visible: false },
};

// â”€â”€â”€ UTILITIES â”€â”€â”€
function timeAgo(ts) {
  const m = Math.floor((Date.now() - ts) / 60000);
  if (m < 1) return 'ãŸã£ãŸä»Š';
  if (m < 60) return m + 'åˆ†å‰';
  const h = Math.floor(m / 60);
  if (h < 24) return h + 'æ™‚é–“å‰';
  return Math.floor(h / 24) + 'æ—¥å‰';
}

function magColor(m) {
  if (m >= 7) return '#ff1744';
  if (m >= 5) return '#ff9100';
  if (m >= 4) return '#ffea00';
  if (m >= 3) return '#76ff03';
  return '#40c4ff';
}

function magLabel(m) {
  if (m >= 7) return 'å·¨å¤§';
  if (m >= 5) return 'å¼·ã„';
  if (m >= 4) return 'ä¸­è¦æ¨¡';
  if (m >= 3) return 'å¼±ã„';
  return 'å¾®å°';
}

function levelColor(l) {
  return { CRIT: '#ff1744', HIGH: '#ff9100', MED: '#ffea00', LOW: '#76ff03', INFO: '#40c4ff' }[l] || '#40c4ff';
}

function isJapan(place) {
  if (!place) return false;
  return /Japan|Bonin|Ryukyu|Hokkaido|Honshu|Shikoku|Kyushu|Okinawa|Izu Islands/i.test(place);
}

// â”€â”€â”€ CLOCK â”€â”€â”€
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ja-JP', { timeZone: 'Asia/Tokyo', hour12: false }) + ' JST';
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€â”€ MAP INIT â”€â”€â”€
function initMap() {
  map = L.map('map', {
    center: [35, 136],
    zoom: 3,
    minZoom: 2,
    maxZoom: 10,
    zoomControl: true,
    attributionControl: false,
    dragging: true,
    scrollWheelZoom: true,
    doubleClickZoom: true,
    touchZoom: true,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    className: 'dark-tiles',
    maxZoom: 19,
  }).addTo(map);

  layers.earthquakes.group = L.layerGroup().addTo(map);
  layers.volcanoes.group = L.layerGroup().addTo(map);
  layers.wildfires.group = L.layerGroup();
  layers.conflicts.group = L.layerGroup().addTo(map);
  layers.nuclear.group = L.layerGroup();
  layers.storms.group = L.layerGroup();
  eqLayer = layers.earthquakes.group;
}

function updateMapMarkers(features) {
  eqLayer.clearLayers();
  features.forEach(f => {
    const [lon, lat] = f.geometry.coordinates;
    const mag = f.properties.mag;
    const color = magColor(mag);
    const r = Math.max(4, mag * 3.5);
    const jp = isJapan(f.properties.place);

    // Pulse circle
    L.circleMarker([lat, lon], {
      radius: r * 1.8,
      color: color,
      fillColor: color,
      fillOpacity: 0.12,
      weight: 0,
      className: 'eq-pulse'
    }).addTo(eqLayer);

    // Main marker
    const marker = L.circleMarker([lat, lon], {
      radius: r,
      color: jp ? '#0ff' : color,
      fillColor: color,
      fillOpacity: 0.6,
      weight: jp ? 2 : 1,
    }).addTo(eqLayer);

    const depth = f.geometry.coordinates[2];
    marker.bindPopup(`
      <div style="min-width:160px">
        <div class="popup-mag" style="color:${color}">M${mag.toFixed(1)} â€” ${magLabel(mag)}</div>
        <div class="popup-place">${f.properties.place || 'ä¸æ˜'}</div>
        <div class="popup-depth">æ·±ã•: ${depth.toFixed(1)}km | ${timeAgo(f.properties.time)}</div>
        ${f.properties.tsunami === 1 ? '<div style="color:#ff1744;font-weight:700;margin-top:4px">âš  æ´¥æ³¢æ³¨æ„</div>' : ''}
        ${jp ? '<div style="color:#0ff;margin-top:2px">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å‘¨è¾º</div>' : ''}
      </div>
    `);
  });
}

// â”€â”€â”€ EARTHQUAKE LIST â”€â”€â”€
function renderEqItem(f, idx, isJp) {
  const { mag, place, time, tsunami } = f.properties;
  const depth = f.geometry.coordinates[2];
  const color = magColor(mag);
  const jp = isJp || isJapan(place);
  return `
    <div class="eq-item ${jp ? 'japan' : ''}" style="animation:fadeIn 0.3s ease-out ${idx * 0.03}s both">
      <div class="eq-top">
        <span class="eq-mag" style="background:${color}20;color:${color};border:1px solid ${color}50">M${mag.toFixed(1)}</span>
        <span class="eq-mag-label" style="background:${color}10;color:${color}">${magLabel(mag)}</span>
        ${tsunami === 1 ? '<span class="eq-tsunami">âš  æ´¥æ³¢æ³¨æ„</span>' : ''}
        ${jp ? '<span class="eq-japan-badge">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</span>' : ''}
        <span class="eq-time">${timeAgo(time)}</span>
      </div>
      <div class="eq-place">${place || 'ä¸æ˜ãªå ´æ‰€'}</div>
      <div class="eq-depth">æ·±ã•: ${depth.toFixed(1)}km</div>
    </div>
  `;
}

function updateEarthquakeList(features) {
  const japanFeatures = features.filter(f => isJapan(f.properties.place));
  const total = features.length;
  const japanCount = japanFeatures.length;
  const maxMag = total > 0 ? Math.max(...features.map(f => f.properties.mag)) : 0;
  const avgMag = total > 0 ? (features.reduce((s, f) => s + f.properties.mag, 0) / total) : 0;

  // Stats
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statJapan').textContent = japanCount;
  document.getElementById('statJapan').style.color = japanCount > 0 ? 'var(--orange)' : 'var(--green)';
  document.getElementById('statMax').textContent = maxMag.toFixed(1);
  document.getElementById('statMax').style.color = magColor(maxMag);
  document.getElementById('statAvg').textContent = avgMag.toFixed(1);
  document.getElementById('eqTotal').textContent = total;
  document.getElementById('eqCountBadge').textContent = 'åœ°éœ‡ ' + total;

  // Japan section
  if (japanCount > 0) {
    document.getElementById('japanLabel').style.display = 'block';
    document.getElementById('japanCount').textContent = japanCount;
    document.getElementById('japanQuakes').innerHTML = japanFeatures.slice(0, 5).map((f, i) => renderEqItem(f, i, true)).join('');
  } else {
    document.getElementById('japanLabel').style.display = 'none';
    document.getElementById('japanQuakes').innerHTML = '';
  }

  // All quakes
  document.getElementById('allQuakes').innerHTML = features.slice(0, 40).map((f, i) => renderEqItem(f, i)).join('');

  // Threat level
  const hasHigh = maxMag >= 5;
  const elevated = hasHigh || japanCount > 3;
  const badge = document.getElementById('threatBadge');
  const dot = document.getElementById('threatDot');
  const text = document.getElementById('threatText');
  badge.className = 'threat-badge ' + (elevated ? 'elevated' : 'normal');
  dot.style.background = elevated ? 'var(--orange)' : 'var(--green)';
  text.textContent = elevated ? 'è­¦æˆ’ãƒ¬ãƒ™ãƒ«: é«˜' : 'è­¦æˆ’ãƒ¬ãƒ™ãƒ«: é€šå¸¸';

  // Gauge
  const level = maxMag >= 6 ? 85 : maxMag >= 5 ? 65 : maxMag >= 4 ? 45 : maxMag >= 3 ? 30 : 15;
  const levelText = level >= 70 ? 'å±é™º' : level >= 50 ? 'è­¦æˆ’' : level >= 30 ? 'æ³¨æ„' : 'å®‰å®š';
  const gaugeColor = level >= 70 ? 'var(--red)' : level >= 50 ? 'var(--orange)' : level >= 30 ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('gaugeArc').setAttribute('stroke-dasharray', `${level * 1.42} 142`);
  document.getElementById('gaugeValue').textContent = level;
  document.getElementById('gaugeValue').setAttribute('fill', gaugeColor);
  document.getElementById('gaugeLabel').textContent = levelText;
  document.getElementById('gaugeLabel').setAttribute('fill', gaugeColor);

  // Summary
  let summary = `éå»24æ™‚é–“ã§M2.5ä»¥ä¸Šã®åœ°éœ‡ãŒ<span class="summary-hl" style="color:var(--cyan)">${total}ä»¶</span>è¦³æ¸¬ã€‚`;
  if (japanCount > 0) {
    summary += `æ—¥æœ¬å‘¨è¾ºã§ã¯<span class="summary-hl" style="color:var(--orange)">${japanCount}ä»¶</span>ã‚’ç¢ºèªã€‚`;
  } else {
    summary += `æ—¥æœ¬å‘¨è¾ºã§ã®æœ‰æ„Ÿåœ°éœ‡ã¯<span style="color:var(--green)">ãªã—</span>ã€‚`;
  }
  if (hasHigh) {
    summary += `<span style="color:var(--orange)"> M5.0ä»¥ä¸Šã®åœ°éœ‡ãŒç™ºç”Ÿã—ã¦ãŠã‚Šã€è­¦æˆ’ãƒ¬ãƒ™ãƒ«ã‚’å¼•ãä¸Šã’ä¸­ã€‚</span>`;
  }
  document.getElementById('summaryText').innerHTML = summary;
  document.getElementById('lastUpdate').textContent = 'æ›´æ–°: ' + new Date().toLocaleTimeString('ja-JP', { timeZone: 'Asia/Tokyo' });
}

// â”€â”€â”€ FETCH EARTHQUAKE DATA â”€â”€â”€
async function fetchEarthquakes() {
  try {
    const res = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson');
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    earthquakeData = data.features || [];
    updateEarthquakeList(earthquakeData);
    updateMapMarkers(earthquakeData);
    updateLayerCount('earthquakes', earthquakeData.length);
    document.getElementById('apiStatus').textContent = 'ONLINE';
    document.getElementById('apiStatus').className = 'status-online';
  } catch (e) {
    document.getElementById('apiStatus').textContent = 'ERROR';
    document.getElementById('apiStatus').className = 'status-error';
    if (earthquakeData.length === 0) {
      document.getElementById('allQuakes').innerHTML = '<div style="padding:20px;text-align:center;color:var(--orange);font-family:var(--mono);font-size:12px">åœ°éœ‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒˆãƒ©ã‚¤ä¸­...</div>';
    }
  }
}

// â”€â”€â”€ NEWS RENDERING â”€â”€â”€
function formatNewsAge(hours) {
  if (hours < 0.5) return 'ãŸã£ãŸä»Š';
  if (hours < 1) return '30åˆ†å‰';
  if (hours < 24) return Math.floor(hours) + 'æ™‚é–“å‰';
  return Math.floor(hours / 24) + 'æ—¥å‰';
}

function renderNews(items) {
  const body = document.getElementById('newsBody');
  if (!items || items.length === 0) {
    body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--text-dim);font-family:var(--mono);font-size:11px">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­...</div>';
    return;
  }
  body.innerHTML = items.map((item, i) => {
    const lc = levelColor(item.level);
    const titleHtml = item.url
      ? `<a href="${item.url}" target="_blank" rel="noopener" class="news-title" style="text-decoration:none;color:var(--text)">${item.title}</a>`
      : `<div class="news-title">${item.title}</div>`;
    return `
      <div class="news-item" style="animation:fadeIn 0.3s ease-out ${i * 0.04}s both">
        <div class="news-top">
          <span class="news-level" style="background:${lc}15;color:${lc};border:1px solid ${lc}40">${item.level}</span>
          <span class="news-category">${item.cat}</span>
          <span class="news-time">${formatNewsAge(item.age)}</span>
        </div>
        ${titleHtml}
        <div class="news-source">${item.source}</div>
      </div>
    `;
  }).join('');

  // Tags
  const cats = {};
  items.forEach(i => cats[i.cat] = (cats[i.cat] || 0) + 1);
  document.getElementById('tagBar').innerHTML = Object.entries(cats).map(([c, n]) => `<span class="tag">${c} ${n}</span>`).join('');

  // Count
  document.getElementById('newsCount').textContent = items.length;
  document.getElementById('newsSubLabel').innerHTML =
    currentTab === 'world' ? `åœ°æ”¿å­¦ãƒ»çµŒæ¸ˆãƒ»ç´›äº‰ â€” <span id="newsCount">${items.length}</span> ä»¶` :
    `AIãƒ»åŠå°ä½“ãƒ»å®‡å®™ â€” <span id="newsCount">${items.length}</span> ä»¶`;
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tabWorld').className = 'tab' + (tab === 'world' ? ' active' : '');
  document.getElementById('tabTech').className = 'tab' + (tab === 'tech' ? ' active' : '');
  const items = tab === 'world' ? WORLD_NEWS : TECH_NEWS;
  renderNews(items);
}

// â”€â”€â”€ LAYER CONTROLS â”€â”€â”€
function toggleLayer(name, visible) {
  layers[name].visible = visible;
  if (visible) {
    map.addLayer(layers[name].group);
  } else {
    map.removeLayer(layers[name].group);
  }
}

function toggleLayerPanel() {
  const panel = document.getElementById('layerPanel');
  const btn = document.getElementById('layerToggleBtn');
  panel.classList.toggle('hidden');
  btn.classList.toggle('hidden');
}

function updateLayerCount(name, count) {
  const el = document.getElementById('layerCount-' + name);
  if (el) el.textContent = count;
}

// â”€â”€â”€ FETCH: VOLCANOES (NASA EONET) â”€â”€â”€
async function fetchVolcanoes() {
  try {
    const res = await fetch('https://eonet.gsfc.nasa.gov/api/v3/events/geojson?status=open&category=volcanoes');
    const data = await res.json();
    const features = data.features || [];
    layers.volcanoes.group.clearLayers();
    features.forEach(f => {
      const coords = f.geometry.coordinates;
      const [lon, lat] = Array.isArray(coords[0]) ? coords[coords.length - 1] : coords;
      L.marker([lat, lon], {
        icon: L.divIcon({
          className: '',
          html: '<span style="font-size:16px;filter:drop-shadow(0 0 4px #ff6600)">ğŸŒ‹</span>',
          iconSize: [20, 20], iconAnchor: [10, 10]
        })
      }).addTo(layers.volcanoes.group)
        .bindPopup(`<div style="min-width:140px">
          <div style="color:#ff6600;font-weight:700;font-family:var(--mono)">ğŸŒ‹ VOLCANO</div>
          <div style="margin-top:4px">${f.properties.title || 'ä¸æ˜'}</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${f.properties.date ? new Date(f.properties.date).toLocaleDateString('ja-JP') : '---'}</div>
        </div>`);
    });
    updateLayerCount('volcanoes', features.length);
  } catch(e) { console.error('Volcano fetch error:', e); }
}

// â”€â”€â”€ FETCH: WILDFIRES (NASA EONET) â”€â”€â”€
async function fetchWildfires() {
  try {
    const res = await fetch('https://eonet.gsfc.nasa.gov/api/v3/events/geojson?status=open&category=wildfires&limit=100');
    const data = await res.json();
    const features = data.features || [];
    layers.wildfires.group.clearLayers();
    features.forEach(f => {
      const coords = f.geometry.coordinates;
      const [lon, lat] = Array.isArray(coords[0]) ? coords[coords.length - 1] : coords;
      L.circleMarker([lat, lon], {
        radius: 5,
        color: '#ff6600',
        fillColor: '#ff6600',
        fillOpacity: 0.4,
        weight: 1,
      }).addTo(layers.wildfires.group)
        .bindPopup(`<div style="min-width:140px">
          <div style="color:#ff6600;font-weight:700;font-family:var(--mono)">ğŸ”¥ WILDFIRE</div>
          <div style="margin-top:4px">${f.properties.title || 'ä¸æ˜'}</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${f.properties.date ? new Date(f.properties.date).toLocaleDateString('ja-JP') : '---'}</div>
        </div>`);
    });
    updateLayerCount('wildfires', features.length);
  } catch(e) { console.error('Wildfire fetch error:', e); }
}

// â”€â”€â”€ FETCH: CONFLICTS (GDELT GEO 2.0) â”€â”€â”€
async function fetchConflicts() {
  try {
    const url = 'https://api.gdeltproject.org/api/v2/geo/geo?query=(conflict OR protest OR military OR attack)&mode=PointData&format=GeoJSON&timespan=1440';
    const res = await fetch(url);
    const data = await res.json();
    const features = (data.features || []).filter(f =>
      f.geometry && f.geometry.coordinates &&
      f.geometry.coordinates[0] !== 0 && f.geometry.coordinates[1] !== 0
    );
    layers.conflicts.group.clearLayers();
    features.forEach(f => {
      const [lon, lat] = f.geometry.coordinates;
      const count = (f.properties && f.properties.count) || 1;
      const r = Math.min(15, Math.max(3, Math.log10(count + 1) * 5));
      L.circleMarker([lat, lon], {
        radius: r,
        color: '#ff1744',
        fillColor: '#ff4444',
        fillOpacity: 0.25,
        weight: 1,
      }).addTo(layers.conflicts.group)
        .bindPopup(`<div style="min-width:140px">
          <div style="color:#ff1744;font-weight:700;font-family:var(--mono)">âš¡ CONFLICT INTEL</div>
          <div style="margin-top:4px">${(f.properties && f.properties.name) || 'ä¸æ˜'}</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px">å ±é“ä»¶æ•°: ${count.toLocaleString()}</div>
        </div>`);
    });
    updateLayerCount('conflicts', features.length);
  } catch(e) { console.error('Conflict fetch error:', e); }
}

// â”€â”€â”€ FETCH: NUCLEAR PLANTS (GeoNuclearData) â”€â”€â”€
async function fetchNuclearPlants() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/cristianst85/GeoNuclearData/master/data/json/denormalized/nuclear_power_plants.json');
    const data = await res.json();
    const operational = data.filter(p => p.Status === 'Operational' && p.Latitude && p.Longitude);
    layers.nuclear.group.clearLayers();
    operational.forEach(p => {
      L.circleMarker([p.Latitude, p.Longitude], {
        radius: 5,
        color: '#ffea00',
        fillColor: '#ffea00',
        fillOpacity: 0.5,
        weight: 1,
      }).addTo(layers.nuclear.group)
        .bindPopup(`<div style="min-width:140px">
          <div style="color:#ffea00;font-weight:700;font-family:var(--mono)">â˜¢ NUCLEAR</div>
          <div style="margin-top:4px">${p.Name}</div>
          <div style="font-size:10px;color:var(--text-dim)">${p.Country} | ${p.ReactorType || '---'} | ${p.Capacity ? p.Capacity + ' MWe' : '---'}</div>
        </div>`);
    });
    updateLayerCount('nuclear', operational.length);
  } catch(e) { console.error('Nuclear fetch error:', e); }
}

// â”€â”€â”€ FETCH: SEVERE STORMS (NASA EONET) â”€â”€â”€
async function fetchStorms() {
  try {
    const res = await fetch('https://eonet.gsfc.nasa.gov/api/v3/events/geojson?status=open&category=severeStorms');
    const data = await res.json();
    const features = data.features || [];
    layers.storms.group.clearLayers();
    features.forEach(f => {
      const coords = f.geometry.coordinates;
      const [lon, lat] = Array.isArray(coords[0]) ? coords[coords.length - 1] : coords;
      L.marker([lat, lon], {
        icon: L.divIcon({
          className: '',
          html: '<span style="font-size:18px;filter:drop-shadow(0 0 6px #40c4ff)">ğŸŒ€</span>',
          iconSize: [22, 22], iconAnchor: [11, 11]
        })
      }).addTo(layers.storms.group)
        .bindPopup(`<div style="min-width:140px">
          <div style="color:#40c4ff;font-weight:700;font-family:var(--mono)">ğŸŒ€ STORM</div>
          <div style="margin-top:4px">${f.properties.title || 'ä¸æ˜'}</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${f.properties.date ? new Date(f.properties.date).toLocaleDateString('ja-JP') : '---'}</div>
        </div>`);
    });
    updateLayerCount('storms', features.length);
  } catch(e) { console.error('Storm fetch error:', e); }
}

// â”€â”€â”€ INIT â”€â”€â”€
initMap();
setTimeout(() => { map.invalidateSize(); map.setView([35, 136], 3); }, 200);
window.addEventListener('resize', () => map.invalidateSize());

// Fetch all layers
fetchEarthquakes();
fetchVolcanoes();
fetchWildfires();
fetchConflicts();
fetchNuclearPlants();
fetchStorms();

// Refresh intervals
setInterval(fetchEarthquakes, 120000);    // 2 min
setInterval(fetchVolcanoes, 1800000);     // 30 min
setInterval(fetchWildfires, 1800000);     // 30 min
setInterval(fetchConflicts, 3600000);     // 60 min
setInterval(fetchStorms, 1800000);        // 30 min

// News fetch (staggered to avoid GDELT rate limits)
renderNews(WORLD_NEWS); // show loading state
fetchWorldNews();
setTimeout(fetchTechNews, 5000);         // stagger 5s
setInterval(fetchWorldNews, 300000);     // 5 min
setInterval(fetchTechNews, 300000);      // 5 min
</script>
</body>
</html>
